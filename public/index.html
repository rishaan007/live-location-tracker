<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Location with Address</title>
  <link
    href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body, html { margin: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    const socket = io();

    // Initialize MapLibre Map
    const map = new maplibregl.Map({
      container: "map",
      style: "https://demotiles.maplibre.org/style.json",
      center: [0, 0], // default center
      zoom: 2,
    });

    let marker;

    // Get current location continuously
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition((position) => {
        const coords = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
        };

        // Send to backend
        socket.emit("send-location", coords);
      });
    }

    // Receive updated location
    socket.on("receive-location", async (coords) => {
      const { latitude, longitude } = coords;

      if (!marker) {
        marker = new maplibregl.Marker().setLngLat([longitude, latitude]).addTo(map);
      } else {
        marker.setLngLat([longitude, latitude]);
      }

      map.setCenter([longitude, latitude]);
      map.setZoom(15);

      // ðŸ”¹ Fetch address from OpenStreetMap (Nominatim)
      try {
        const res = await fetch(
          `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`
        );
        const data = await res.json();
        const address = data.display_name;

        // Show popup with address
        new maplibregl.Popup()
          .setLngLat([longitude, latitude])
          .setHTML(`<b>Your Location:</b><br>${address}`)
          .addTo(map);
      } catch (err) {
        console.error("Failed to get address", err);
      }
    });
  </script>
</body>
</html>
